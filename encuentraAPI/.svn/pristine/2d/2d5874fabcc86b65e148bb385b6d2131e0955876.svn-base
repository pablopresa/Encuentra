package logica;

import java.math.BigInteger;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.List;

import beans.CallBackPedido;
import beans.Usuario;
import beans.jsonEstadoMP;
import beans.api.EquiposPrintSpool;
import beans.api.GrabarRecepcion;
import beans.api.MovStock;
import beans.api.pedidoFactura;
import beans.api.json.PrintObject;
import beans.api.json.RetornoPedido;
import beans.api.json.SendMail;
import beans.datatypes.DataIDDescripcion;
import beans.encuentra.Articulo;
import beans.encuentra.Compras;
import beans.encuentra.EncuentraPedidoArticulo;
import beans.encuentra.Familias;
import beans.encuentra.Maestros;
import beans.encuentra.Ordenes;
import beans.encuentra.OrdenesLineas;
import integraciones.erp.visualStore.objetos.OrdenVenta;
import integraciones.marketplaces.fenicio.Lineas;
import integraciones.marketplaces.objetos.CanalMarketPlace;
import integraciones.wms.Call_WS_APIENCUENTRA;
import persistencia.MSSQL_API;
import persistencia._EncuentraConexionAPI;
import persistencia._EncuentraConexionAPI2;


public class LogicaAPI 
{

	
	public boolean darIntegracionProductiva(int idIntegracion, int idEmpresa)
	{
		//return hayRegistro("select * from integraciones where idIntegracion = "+idIntegracion+" and IdEmpresa="+idEmpresa+" and Productivo = 1");
		return false;
	}
	
	public static RetornoPedido encuentraDarOjosPedido(String articulo) {
		Connection cone;
		try {
			cone = _EncuentraConexionAPI.getConnection("encuentra_unilam");

			String consulta = "SELECT CONCAT(DE.idDeposito,' - ',DE.Nombre,' ',DE.Nombre2) AS CTE, true as DSP , CONCAT(EST.Descripcion, ' ', OJO.idOjo ) AS UBI "+
							"	FROM pedido PE  "+
							"	INNER JOIN depositos DE ON PE.IdCliente = DE.idDeposito "+ 
							"	INNER JOIN  reposicion_articulos RAO ON DE.idDeposito = RAO.Destino "+
							"	INNER JOIN ojostienenarticulos OTA "+ 
							"	INNER JOIN ojos OJO ON OJO.idOjo = OTA.idOjo "+
							"	INNER JOIN estanterias EST ON EST.idEstanteria = OJO.idEstanteria AND EST.TipoSector IN (11,12,13) "+
							"	WHERE PE.idPedido = "+articulo+" "+
							"	GROUP BY OTA.idOjo";
			
			return _EncuentraConexionAPI.darArticulosOjos(consulta, articulo);

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	
	public static Usuario loginEncuentraBantey(String token) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String consulta = "select U.* from usuarios U inner join apitoken T on T.idUsuario=U.idUsuario where Token = '"+token+"'";

			Usuario u = new Usuario();

			u = _EncuentraConexionAPI.login(consulta);
			cone = null;
			return u;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	
	public static Usuario loginEncuentraAPI(String token) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String consulta = "select U.* from usuarios U inner join apitoken T on T.idUsuario=U.idUsuario where Token = '"+token+"'";

			Usuario u = new Usuario();

			u = _EncuentraConexionAPI.login(consulta);
			cone = null;
			return u;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static Usuario loginEncuentraAPI2(String token) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "select U.* from usuarios U inner join apitoken T on T.idUsuario=U.idUsuario where Token = '"+token+"'";

			Usuario u = new Usuario();

			u = _EncuentraConexionAPI2.login(consulta);
			cone = null;
			return u;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String darTokenVivoCliente(int idEmpresa, String uso,int tiempo) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "SELECT token FROM temp_tokens WHERE Uso = '"+uso+"' AND idEmpresa = "+idEmpresa+" AND TIMESTAMPDIFF(MINUTE,Leased,CURRENT_TIMESTAMP())<"+tiempo+"";

			 return _EncuentraConexionAPI2.dartokenApi(consulta);

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}


	
	
	public static String darBarrio(String cpostal) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "SELECT * FROM barrios_localidades WHERE Cpostal = '"+cpostal+"' LIMIT 1";

			

			String u = _EncuentraConexionAPI2.barrio(consulta);
			cone = null;
			return u;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	
	public static int limpiarOrden(String idOrdenERP)
	{
		int retorno = 0;
		try
		{
			idOrdenERP = idOrdenERP.replaceAll("[^\\d.]", "");
			
			retorno = Integer.parseInt((Integer.parseInt(idOrdenERP)+"").substring(0,6));
			
			
		}
		catch (Exception e) 
		{

		}
		
		
		
		return retorno;
	}
	
	public String darHostFenicioAPI (int idEmpresa, String idCanal)
	{
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "SELECT 0, hostAPI FROM ecommerce_marketplaces_canales WHERE IdEmpresa = "+idEmpresa+" AND id = "+idCanal;

			

			String u = _EncuentraConexionAPI2.barrio(consulta);
			cone = null;
			return u;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String ingresarOrdenBantey(Ordenes[] ords) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String insert = "";
			String msj="";
			int retorno=0;
			
			
			for(Ordenes o:ords)
			{
				String venta = o.getIdVenta();
				
				if(o.getIdOrdenVentaERP()!=null)
				{
					int idOrden = limpiarOrden(o.getIdOrdenVentaERP());
					o.setIdOrdenVentaERP(idOrden+"");
				}
				if(!o.getIdOrdenVentaERP().equals("0"))
				{
					String cliente = "";
					String clienteVal = "";
					
					String guia = "";
					String guiaVal = "";
					
					String etiqueta = "";
					String etiquetaVal = "";
					
					String fecha = "";
					String fechaVal = "";
					
					String hora = "";
					String horaVal = "";
					
					String mail = "";
					String mailVal = "";
					
					String celular = "";
					String celularVal = "";
					
					String departamento = "";
					String departamentoVal = "";
					
					String localidad = "";
					String localidadVal = "";
					
					String direccion = "";
					String direccionVal = "";
					
					String observacion = "";
					String observacionVal = "";
					
					
					int envioMont = 0;
					int susp = 0;
					
					if(o.getDatosCliente()!=null && !o.getDatosCliente().equals(""))
					{
						cliente = ",cliente";
						clienteVal = ",'"+o.getDatosCliente()+"'";
					}
					else if(o.getDescripcion()!=null && !o.getDescripcion().equals(""))
					{
						cliente = ",cliente";
						clienteVal = ",'"+o.getDescripcion()+"'";
					}
					
								
					if(o.getGuia() !=null && o.getGuia().length>0)
					{
						guia = ",guia";
						String guias = "";
						if(o.getGuia().length>1)
						{
							for (int i = 0; i < o.getGuia().length; i++) 
							{
								guias+=o.getGuia()[i]+",";
							}
						}
						else
						{
							guias = o.getGuia()[0];
						}
						
						guiaVal = ",'"+guias+"'";
					}
				
					if(o.getUrlEtiqueta() !=null && !o.getUrlEtiqueta().equals(""))
					{
						etiqueta = ",URLEtiqueta";
						etiquetaVal = ",'"+o.getUrlEtiqueta()+"'";
					}
					
					if(o.getFecha() !=null && !o.getFecha().equals(""))
					{
						fecha = ",fechaEntrega";
						fechaVal = ",'"+o.getFecha()+"'";
					}
					
					if(o.getHora() !=null && !o.getHora().equals(""))
					{
						hora = ",hora";
						horaVal = ",'"+o.getHora()+"'";
					}
					
					if(o.getMail() !=null && !o.getMail().equals(""))
					{
						mail = ",mail";
						mailVal = ",'"+o.getMail()+"'";
					}
					
					if(o.getCelular() !=null && !o.getCelular().equals(""))
					{
						celular = ",celular";
						celularVal = ",'"+o.getCelular()+"'";
					}
					
					if(o.getDepartamento() !=null && !o.getDepartamento().equals(""))
					{
						departamento = ",departamento";
						departamentoVal = ",'"+o.getDepartamento()+"'";
					}
					
					if(o.getLocalidad() !=null && !o.getLocalidad().equals(""))
					{
						localidad = ",localidad";
						localidadVal = ",'"+o.getLocalidad()+"'";
					}
					
					if(o.getDireccion() !=null && !o.getDireccion().equals(""))
					{
						direccion = ",direccion";
						direccionVal = ",'"+o.getDireccion()+"'";
					}
					
					if(o.getObservacion() !=null && !o.getObservacion().equals(""))
					{
						observacion = ",observacion";
						observacionVal = ",'"+o.getObservacion()+"'";
					}
					
					try {
						if(o.isEnvio_montevideo()){
							envioMont = 1;
						}
					} catch (Exception e) {
						// TODO: handle exception
					}
					
					try {
						if(o.isSuspendida()){
							susp = 1;
						}
					} catch (Exception e) {
						// TODO: handle exception
					}
					
					

					insert="insert into ecommerce_venta(idVenta,canalVenta,codCanalSalida"+cliente+guia+etiqueta+fecha+",idVentaCanal,envioMontevideo,suspendida"+hora+mail+celular+departamento+localidad+direccion+observacion+") values("+o.getIdOrdenVentaERP()+",'"+o.getCodCanal()+"','"+o.getCodCanalSalida()+"'"+clienteVal+guiaVal+etiquetaVal+fechaVal+",'"+o.getIdVenta()+"',"+envioMont+","+susp+horaVal+mailVal+celularVal+departamentoVal+localidadVal+direccionVal+observacionVal+")";

					retorno=_EncuentraConexionAPI.persistir(insert);
					if(retorno > 0)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"1\" },";
					}
					else if(retorno == 0)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"0\" },";
					}
					else if(retorno == -2)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"-1\" },";
					}
					retorno = 0;
				}
				else
				{
					msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"-1\" },";
				}
				
				
			}	
			
			if(msj.length()>0)
			{
				msj=msj.substring(0,msj.length()-1);
				
			}
						 
			msj = "{\"ordenes\": ["+msj+"]}";
			cone = null;
			return msj;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String modificarOrdenBantey(Ordenes[] ords) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String insert = "";
			String msj="";
			int retorno=0;
			
			
			for(Ordenes o:ords)
			{
				String venta = o.getIdVenta();
				
				if(o.getIdOrdenVentaERP()!=null)
				{
					int idOrden = limpiarOrden(o.getIdOrdenVentaERP());
					o.setIdOrdenVentaERP(idOrden+"");
				}
				if(!o.getIdOrdenVentaERP().equals("0"))
				{
					String salidaVal = "";
					
					String clienteVal = "";
					
					String guiaVal = "";
					
					String etiquetaVal = "";
					
					String fechaVal = "";
					
					String suspVal = "";
					
					if(o.getCodCanalSalida()!=null && !o.getCodCanalSalida().equals("")){
						salidaVal = "codCanalSalida = '"+o.getCodCanalSalida()+"', ";
					}
					
					if(o.getDatosCliente()!=null && !o.getDatosCliente().equals(""))
					{
						
						clienteVal = " cliente ='"+o.getDatosCliente()+"', ";
					}
					else if(o.getDescripcion()!=null && !o.getDescripcion().equals(""))
					{
						clienteVal = " cliente = '"+o.getDescripcion()+"', ";
					}
					
								
					if(o.getGuia() !=null && o.getGuia().length>0)
					{
						
						String guias = "";
						if(o.getGuia().length>1)
						{
							for (int i = 0; i < o.getGuia().length; i++) 
							{
								guias+=o.getGuia()[i]+",";
							}
						}
						else
						{
							guias = o.getGuia()[0];
						}
						
						guiaVal = " guia='"+guias+"', ";
					}
				
					if(o.getUrlEtiqueta() !=null && !o.getUrlEtiqueta().equals(""))
					{					
						etiquetaVal = " URLEtiqueta='"+o.getUrlEtiqueta()+"', ";
					}
					
					if(o.getFecha() !=null && !o.getFecha().equals(""))
					{
						fechaVal = " fechaEntrega='"+o.getFecha()+"', ";
					}
					
					try {
						if(o.isSuspendida()==false){
							suspVal = " suspendida = 0, ";
						}
					} catch (Exception e) {
						// TODO: handle exception
					}
					
					
					insert = "update ecommerce_venta set "+salidaVal+clienteVal+guiaVal+etiquetaVal+fechaVal+suspVal;
					insert = insert.substring(0,insert.length()-2);
					insert+=" where idventa = "+o.getIdOrdenVentaERP();
					retorno=_EncuentraConexionAPI.persistir(insert);
					if(retorno > 0)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"1\" },";
					}
					else if(retorno == 0)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"0\" },";
					}
					else if(retorno == -2)
					{
						msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"-1\" },";
					}
					retorno = 0;
				}
				else
				{
					msj+="{\"idVenta\": \""+o.getIdOrdenVentaERP()+"\",\"codRespuesta\": \"-1\" },";
				}
				
				
			}	
			
			if(msj.length()>0)
			{
				msj=msj.substring(0,msj.length()-1);
				
			}
						 
			msj = "{\"ordenes\": ["+msj+"]}";
			cone = null;
			return msj;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String ingresarArticuloBantey(Articulo[] art) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String insert = "";
			String msj="";
			int retorno=0;
			
			for(Articulo a:art){
				
				insert="insert into articulos(idArticulo,Descripcion,AnchoCaja,AltoCaja,ProfCaja,especificaciones,peso,seriado) "+ 
				"values('"+a.getIdArticulo()+"','"+a.getDescripcion()+"',"+a.getAncho()+","+a.getAlto()+","+a.getProf()+",'"+a.getEspecificaciones()+
				"',"+a.getPeso()+","+a.getSeriado()+");";
				retorno=_EncuentraConexionAPI.persistir(insert);
				
				if(retorno==0){
					insert="update articulos set ";
					if(!a.getDescripcion().equals("")){
						insert+="Descripcion='"+a.getDescripcion()+"',";
					}
					if(!a.getAncho().equals("")){
						insert+="AnchoCaja="+a.getAncho()+",";
					}
					if(!a.getAlto().equals("")){
						insert+="AltoCaja="+a.getAlto()+",";
					}
					if(!a.getProf().equals("")){
						insert+="ProfCaja="+a.getProf()+",";
					}
					if(!a.getEspecificaciones().equals("")){
						insert+="especificaciones='"+a.getEspecificaciones()+"',";
					}
					if(!a.getPeso().equals("")){
						insert+="peso="+a.getPeso()+",";
					}
					if(!a.getSeriado().equals("")){
						insert+="seriado="+a.getSeriado()+",";
					}
					
					insert=insert.substring(0,insert.length()-1);
					insert+=" where idArticulo='"+a.getIdArticulo()+"';";
					retorno=_EncuentraConexionAPI.persistir(insert);
				}
				
				if(retorno>=0){
					for(Familias f:a.getFamilias()){
						insert="insert into artcategoriaart values('"+a.getIdArticulo()+"','"+f.getIdFamilia()+"')";
						retorno=_EncuentraConexionAPI.persistir(insert);
						
						if(retorno>=0){
							insert="insert into artseccionart values('"+a.getIdArticulo()+"','"+f.getIdSubFamilia()+"')";
							retorno=_EncuentraConexionAPI.persistir(insert);
							
							if(retorno<0){
								msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"Error al agregar la sub familia "+f.getIdSubFamilia()+"\" },";
								break;
							}
						}
						else{
							msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"Error al agregar la familia "+f.getIdFamilia()+"\" },";
							break;
						}
						
					}
					
					if(retorno>=0){
						for(String barra:a.getBarrasL()){
							insert="insert into artbarra values('"+a.getIdArticulo()+"','"+barra+"')";
							retorno=_EncuentraConexionAPI.persistir(insert);
							
							if(retorno<0){
								msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"Error al agregar el codigo de barra "+barra+"\" },";
								break;
							}
						}
					}
					
					if(retorno>=0){
						if(!a.getBarras().equals("")){	
							insert="insert into artbarra values('"+a.getIdArticulo()+"','"+a.getBarras()+"')";
							retorno=_EncuentraConexionAPI.persistir(insert);
							
							if(retorno<0){
								msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"Error al agregar el codigo de barra "+a.getBarras()+"\" },";
								break;
							}
							else{
								msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"OK\" },";
							}
						}
						else{
							msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"OK\" },";
						}
					}
					
				}
				else{
					msj+="{\"idArticulo\": \""+a.getIdArticulo()+"\",\"Respuesta\": \"Error al agregar datos del articulo\" },";
				}
				
				retorno = 0;
				insert="";
			}		
			
			if(msj.length()>0)
			{
				msj=msj.substring(0,msj.length()-1);
				
			}
						 
			msj = "{\"Articulos\": ["+msj+"]}";
			cone = null;
			return msj;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String ingresarMaestrosBantey(Maestros[] msts) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String insert = "";
			String msj="";
			int retorno=0;
			
			for(Maestros m:msts){
				
				if(m.getIdMaestro().equals("Depositos")){
					insert="insert into depositos (IdDepositoSAP,Nombre) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE Nombre='"+m.getDescripcion()+"';";
				}
				if(m.getIdMaestro().equals("Canales_Venta")){
					insert="insert into ecommerce_canal_ml (id,nombre) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE nombre='"+m.getDescripcion()+"';";
				}
				if(m.getIdMaestro().equals("Canales_de_Salida")){
					insert="insert into ecommerce_envioml (nombre,idDeposito,pickup) values('"+m.getDescripcion()+"',"+m.getId()+",0) ON DUPLICATE KEY UPDATE nombre='"+m.getDescripcion()+"';";				
				}
				if(m.getIdMaestro().equals("Marcas")){
					insert="insert into art_marca (id,descripcion) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE descripcion='"+m.getDescripcion()+"';";
				}
				if(m.getIdMaestro().equals("Familias")){
					insert="insert into art_categoria (id,descripcion) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE descripcion='"+m.getDescripcion()+"';";	
				}
				if(m.getIdMaestro().equals("Sub_Familias")){
					insert="insert into art_seccion (id,descripcion) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE descripcion='"+m.getDescripcion()+"';";			
				}
				if(m.getIdMaestro().equals("Tipo_ documento")){
					insert="insert into tiposdocumento (id,descripcion) values("+m.getId()+",'"+m.getDescripcion()+"') ON DUPLICATE KEY UPDATE descripcion='"+m.getDescripcion()+"';";
				}
				
				retorno=_EncuentraConexionAPI.persistir(insert);
				
				if(retorno > 0)
				{
					msj+="{\"idMaestro\": \""+m.getIdMaestro()+"\",\"descripcion\": \""+m.getDescripcion()+"\",\"codRespuesta\": \"1\" },";
				}
				else if(retorno == 0)
				{
					msj+="{\"idMaestro\": \""+m.getIdMaestro()+"\",\"descripcion\": \""+m.getDescripcion()+"\",\"codRespuesta\": \"0\" },";
				}
				else if(retorno == -2)
				{
					msj+="{\"idMaestro\": \""+m.getIdMaestro()+"\",\"descripcion\": \""+m.getDescripcion()+"\",\"codRespuesta\": \"-1\" },";
				}
				retorno = 0;
				insert = "";
			}		
			
			if(msj.length()>0)
			{
				msj=msj.substring(0,msj.length()-1);				
			}
						 
			msj = "{\"Maestros\": ["+msj+"]}";
			cone = null;
			return msj;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public static String ingresarEcommercePedido(Ordenes[] ords) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI.getConnection("encuentra_bantey");
			String insert = "";
			String msj="";
			int retorno=0;
			
			for(Ordenes o:ords)
			{				
				insert="insert into ecommerce__pedido (`idPedido`, `descripcion`, `UnidadesTotal`, `EstadoEcommerce`, `cerrado`, "+
				"`URLetiqueta`, `FormaPago`,idCanalML) VALUES ("+
				o.getIdVenta()+", '"+o.getDescripcion().replace("'", "")+"', "+o.getUnidadesTotal()+", 'procesando', '0', '"+
				o.getUrlEtiqueta()+"', '"+o.getFormaPago()+"',"+o.getCodCanal()+");";
						
				retorno=_EncuentraConexionAPI.persistir(insert);
				
				if(retorno >= 0)
				{
					insert="insert into articulo (`idArticulo`, `Descripcion`, `IdTipo`) values ('"+o.getIdVenta()+"', '"+o.getDescripcion().replace("'", "")+
							"',"+2+");";
					
					retorno=_EncuentraConexionAPI.persistir(insert);
					
					if(retorno>=0){
						
						for(OrdenesLineas ol:o.getLineas()){
							
							insert="insert into ecommerce_pedido_articulos (`idPedido`, `idArticulo`, `cantidadPedido`) VALUES ("+
									o.getIdVenta()+",'"+ol.getIdArticulo()+"',"+ol.getCantidad()+");";
							
							retorno=_EncuentraConexionAPI.persistir(insert);
							
							if(retorno<0){
								msj+="{\"idVenta\": \""+o.getIdVenta()+"\",\"Respuesta\": \"Error al ingresar articulo "+ol.getIdArticulo()+"\" },";
								break;
							}
							
						}
						
						if(retorno>=0){
							  msj+="{\"idVenta\": \""+o.getIdVenta()+"\",\"Respuesta\": \"OK\" },";
						}
					}
					else{
						msj+="{\"idVenta\": \""+o.getIdVenta()+"\",\"Respuesta\": \"Error al ingresar la venta como articulo\" },";
					}
				}
				else 
				{
					msj+="{\"idVenta\": \""+o.getIdVenta()+"\",\"Respuesta\": \"Error al ingresar la venta\" },";
				}
				retorno = 0;
				insert = "";
			}		
			
			if(msj.length()>0)
			{
				msj=msj.substring(0,msj.length()-1);
				
			}
						 
			msj = "{\"Ventas\": ["+msj+"]}";
			cone = null;
			return msj;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}


	public static List<beans.api.DataPrintable> darListaToPrint(String consulta) 
	{
		Connection cone;
		try 
		{
			
			cone = _EncuentraConexionAPI2.getConnection();
			

			

			List<beans.api.DataPrintable> u = _EncuentraConexionAPI2.darColaImpresion(consulta);
			cone = null;
			return u;

		} 
		catch (Exception e) 
		{

			try 
			{
				cone = null;
				cone = _EncuentraConexionAPI2.getConnection();
		
				List<beans.api.DataPrintable> u = _EncuentraConexionAPI2.darColaImpresion(consulta);
				cone = null;
				return u;

			} catch (Exception e2) {

				e.printStackTrace();
				return null;
			}
		}
	}
	
	public static List<SendMail> darListaToSend() 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			//String consulta = "select id,destino,asunto,body,origen from mail_spooler where send = 0 and idEmpresa = "+empresa+"";
			String consulta = "select id,destino,asunto,body,origen,idEmpresa,adjunto from mail_spooler where send = 0 ";
			
			List<SendMail> mails = _EncuentraConexionAPI2.darColaEnvioMails(consulta);
			cone = null;
			return mails;

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}


	public static void persistir(String consulta) 
	{
		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			_EncuentraConexionAPI2.persistir(consulta);
			cone = null;
			

		} 
		catch (Exception e) 
		{

			e.printStackTrace();
			
		}
		
	}
	
	public static void PutPrintSpooler(PrintObject p, int empresa){
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			if(p.getIdEquipo()==null || p.getIdEquipo().equals("")){
				p.setIdEquipo("1");
			}
			String consulta = "insert into print_spooler (id,idEmpresa,urlArchivo,porait,printerID,idEquipo) values ('"+p.getId()+"',"+empresa+",'"
							+p.getUrl()+"',"+p.getPorait()+","+p.getPrinterId()+","+p.getIdEquipo()+") "
							+ "on duplicate key update urlArchivo= '"+p.getUrl()+"', printed = 0, porait = "+p.getPorait()+", printerID = "+p.getPrinterId()+", idEquipo = "+p.getIdEquipo();

			_EncuentraConexionAPI2.persistir(consulta);
			cone = null;

		} catch (Exception e) {

			e.printStackTrace();
		}
	}
	
	
	public static void RePrintSpooler(PrintObject p, int empresa){
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			if(p.getIdEquipo()==null || p.getIdEquipo().equals("")){
				p.setIdEquipo("1");
			}
			String consulta = "update print_spooler set urlArchivo = '"+p.getUrl()+"', IdEquipo = "+p.getIdEquipo()+", printed = 0, porait = "+p.getPorait()+", "+
			"printerID = "+p.getPrinterId()+" where id='"+p.getId()+"' and idEmpresa="+empresa;

			_EncuentraConexionAPI2.persistir(consulta);
			cone = null;

		} catch (Exception e) {

			e.printStackTrace();
		}
	}
	
	public static void PutMailSpooler(SendMail[] mails, int empresa){
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			StringBuilder sb = new StringBuilder();
			int count=0;
			for(SendMail m :mails){
				count++;
				String all_body = "";
				for(String b: m.getBody()){
					all_body += b;
				}
				all_body = all_body.replace("'", "\\'");
				
				
				String consulta = "insert into mail_spooler (id,idEmpresa,destino,asunto,body,origen,adjunto) values "+
				"('"+m.getId()+"',"+empresa+",'"+m.getDestino()+"','"+m.getAsunto()+"','"+all_body+"','"+m.getOrigen()+"','"+m.getAdjunto()+"');";
				System.out.println(consulta);
				_EncuentraConexionAPI2.persistir(consulta);
			}
			
			cone = null;

		} catch (Exception e) {

			e.printStackTrace();
		}
	}


	public String darToken(int idEmpresa, int idUsuario) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "SELECT T.Token FROM apitoken T INNER JOIN usuarios U ON U.idUsuario = T.idUsuario AND U.idUsuario = "+idUsuario+" AND U.idEmpresa= "+idEmpresa+"";
			
			String r =  _EncuentraConexionAPI2.dartokenApi(consulta);
			cone = null;
			return r;
			

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public String darToken(int idEmpresa) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			String consulta = "SELECT T.Token FROM apitoken T INNER JOIN usuarios U ON U.idUsuario = T.idUsuario where U.idEmpresa= "+idEmpresa+"";
			
			String r =  _EncuentraConexionAPI2.dartokenApi(consulta);
			cone = null;
			return r;
			

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	List<DataIDDescripcion> darListaDataIdDescripcionMYSQLConsulta(String q) 
	{

		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			
			List<DataIDDescripcion>  r =  _EncuentraConexionAPI2.darlistaDataIdDesc(q);
			cone = null;
			return r;
			

		} catch (Exception e) {

			e.printStackTrace();
			return null;
		}
	}
	
	public  List<Compras> sincroPedidosWeb(int idEmpresa, String token) 
	{
		List<Compras> compras = new ArrayList<Compras>();
		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			Call_WS_APIENCUENTRA cen = new Call_WS_APIENCUENTRA();
			List<DataIDDescripcion>depositosPick = cen.DarDatosPutOrders(token,2);
			
			Hashtable<String, String> depositosPickHT = new Hashtable<String, String>();
			for (DataIDDescripcion d : depositosPick) 
			{
				depositosPickHT.put(d.getDescripcion(), String.valueOf(d.getId()));
			}
			
				//QUERY
			String queryPedidos = "SELECT  V.AMOUNT,V.OPERATIONID, 'estado' estado, V.FEC_ULT_ACT,'$' moneda,IFNULL(V.CARRIER,0),"
								+ "IFNULL(V.SHIPPINGCOST,'0'), 'MetodoPago' metodoPago, V.IDVENTAPRODUCTECA, "+
								"	IFNULL(V.CONTACTPERSON,''), IFNULL(V.NAME,''),IFNULL(V.NAME,''), V.STATE,IFNULL(V.CITY,''),IFNULL(V.PHONENUMBER,''), "
								+ "0 longitud, IFNULL(V.STREETNAME,''), V.STATE, IFNULL(V.ZIPCODE,''), IFNULL(V.ADRESSNOTES,''), 'CI' , "
								+ "IFNULL(V.TAXID,'0'),V.MARKETPLACE, V.FEC_ULT_ACT,V.PDF, IFNULL(v.trackingnumber,''), "
								+ "IFNULL(fe.articulo,IF(V.SHIPPINGCOST IS NOT NULL,fesd.articulo,'0')), "
								+ "IFNULL(V.STREETNUMBER,''), IFNULL(V.STREETNUMBER_BI,''), V.IsFreeShipping "+
								"	FROM producteca_ecom_pedidos V "+
								" LEFT OUTER JOIN ecommerce_articulo_forma_envio fe on V.CARRIER = fe.idCourier and fe.idEmpresa="+idEmpresa
								+" LEFT OUTER JOIN ecommerce_articulo_forma_envio fesd ON -1 = fesd.idCourier and fesd.idEmpresa="+idEmpresa
								+ " WHERE V.Sincronizada=0";
		
			
			//VENTAS NUEVAS
			int ultimaVenta = cen.DarDatosPutOrders(token,3).get(0).getId();		
			List<Compras> compras2 =_EncuentraConexionAPI2.darComprasWeb(queryPedidos,idEmpresa);
			
			
			compras.addAll(compras2);

			return compras;

		} catch (Exception e) {

			e.printStackTrace();
			return compras;
		}

	}


	public void updatePedidoSinc(String inns, int estado) 
	{
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			String consulta = "UPDATE producteca_ecom_pedidos SET Sincronizada = "+estado+" WHERE OPERATIONID IN ("+inns+")";
			
				System.out.println(consulta);
				_EncuentraConexionAPI2.persistir(consulta);
			
			cone = null;

		} catch (Exception e) {

			e.printStackTrace();
		}
		
	}


	public List<beans.encuentra.Cliente> darClientesProducteca() 
	{

		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			String q = "SELECT substring_index(substring_index(P.CONTACTPERSON, ' ', 1), ' ', -1) AS `nombre`, \r\n" + 
					"				     substring_index(substring_index(P.CONTACTPERSON, ' ', 2), ' ', -1) AS `apellido`,\r\n" + 
					"					      IFNULL(IFNULL(P.STREETNAME,P.STREETNAME_BI),'') calle, \r\n" + 
					"							IFNULL(IFNULL(P.STREETNUMBER, P.STREETNUMBER_BI),'') nroPuerta, \r\n" + 
					"							IFNULL(ifnull(P.STATE, P.CITY),'') Departamento, \r\n" + 
					"							IFNULL(P.CITY,'') 'ciudad', \r\n" + 
					"							IFNULL(P.ZIPCODE,'') CP, \r\n" + 
					"							ifnull(P.PHONENUMBER,''), \r\n" + 
					"							P.MAIL, \r\n" + 
					"							ifnull(P.TAXID,P.IDVENTAPRODUCTECA) cedula, \r\n" + 
					"							ifnull(P.ADRESSNOTES,''),\r\n"+
					"							OPERATIONID" + 
					"						 FROM producteca_ecom_pedidos P \r\n" + 
					"					WHERE P.Sincronizada = 0 ;";
			return _EncuentraConexionAPI2.darClientesProducteca(q);
		}
		catch (Exception e) 
		{
			return new ArrayList<beans.encuentra.Cliente>();
		} 
		 
	}
	public List<beans.encuentra.Cliente> reDarClientesProducteca() 
	{

		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			String q = "SELECT substring_index(substring_index(P.CONTACTPERSON, ' ', 1), ' ', -1) AS `nombre`, \r\n" + 
					"				     substring_index(substring_index(P.CONTACTPERSON, ' ', 2), ' ', -1) AS `apellido`,\r\n" + 
					"					      IFNULL(IFNULL(P.STREETNAME,P.STREETNAME_BI),'') calle, \r\n" + 
					"							IFNULL(IFNULL(P.STREETNUMBER, P.STREETNUMBER_BI),'') nroPuerta, \r\n" + 
					"							IFNULL(ifnull(P.STATE, P.CITY),'') Departamento, \r\n" + 
					"							IFNULL(P.CITY,'') 'ciudad', \r\n" + 
					"							IFNULL(P.ZIPCODE,'') CP, \r\n" + 
					"							ifnull(P.PHONENUMBER,''), \r\n" + 
					"							P.MAIL, \r\n" + 
					"							ifnull(P.TAXID,P.IDVENTAPRODUCTECA) cedula, \r\n" + 
					"							ifnull(P.ADRESSNOTES,''),\r\n"+
					"							OPERATIONID" + 
					"						 FROM producteca_ecom_pedidos P \r\n" + 
					"					WHERE P.OPERATIONID in (4441213717,4445407637,4445412226,4445413993,4445421782);";
			return _EncuentraConexionAPI2.darClientesProducteca(q);
		}
		catch (Exception e) 
		{
			return new ArrayList<beans.encuentra.Cliente>();
		} 
		 
	}
	
	public beans.encuentra.Cliente darClienteProducteca(Long idVenta) 
	{

		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			String q = "SELECT substring_index(substring_index(P.CONTACTPERSON, ' ', 1), ' ', -1) AS `nombre`, \r\n" + 
					"				     substring_index(substring_index(P.CONTACTPERSON, ' ', 2), ' ', -1) AS `apellido`,\r\n" + 
					"					      IFNULL(IFNULL(P.STREETNAME,P.STREETNAME_BI),'') calle, \r\n" + 
					"							IFNULL(IFNULL(P.STREETNUMBER, P.STREETNUMBER_BI),'') nroPuerta, \r\n" + 
					"							IFNULL(ifnull(P.STATE, P.CITY),'') Departamento, \r\n" + 
					"							IFNULL(P.CITY,'') 'ciudad', \r\n" + 
					"							IFNULL(P.ZIPCODE,'') CP, \r\n" + 
					"							ifnull(P.PHONENUMBER,''), \r\n" + 
					"							P.MAIL, \r\n" + 
					"							ifnull(P.TAXID,P.IDVENTAPRODUCTECA) cedula, \r\n" + 
					"							ifnull(P.ADRESSNOTES,''),\r\n"+
					"							OPERATIONID" + 
					"						 FROM producteca_ecom_pedidos P \r\n" + 
					"					WHERE P.operationid = "+idVenta;
			return _EncuentraConexionAPI2.darClienteProducteca(q);
		}
		catch (Exception e) 
		{
			return null;
		} 
		 
	}


	public static List<DataIDDescripcion> darListaDataIdDescripcionConsulMYSQL(String q) 
	{
		try 
		{
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			return _EncuentraConexionAPI2.darListaDataIdDescripcionConsulMYSQL(q);
		}
		catch (Exception e) 
		{
			return new ArrayList<DataIDDescripcion>();
		} 
	}


	public List<DataIDDescripcion> darArticulosCombo(String idCombo, int idEmpresa) 
	{
		String q = "select Cantidad, IdArticulo,0, Precio from ArtCombo where IdCombo = '"+idCombo+"'";
		return MSSQL_API.darIDDescripcion(q, idEmpresa);
	}
	
	public static List<DataIDDescripcion> ecommerceDocumentosEntregas(Long numeroPedido, int idEmpresa) {
		String q = "SELECT NumeroDoc, IdArticulo, \"Cantidad pendiente\" \r\n" + 
				"FROM encuentra_distribucion \r\n" + 
				"WHERE comentario LIKE 'Trans.Venta Dep. 1200 Doc. A-"+numeroPedido+"%'";
		return MSSQL_API.darEcommerceDocumentosEntregas(q, idEmpresa);
	}
	
	public static void UpdateEcommerceDocumentosEntregas(int procesado, int idEmpresa, int idLlamada, String mensaje) {
		
		try {
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			String q = "UPDATE callbackpedidoencuentra \r\n" + 
				"SET procesado = "+procesado+", mensaje = "+mensaje+" \r\n" +
				"WHERE idLlamada = "+idLlamada+" \r\n" + 
				"AND idEmpresa = "+idEmpresa+";";
			
			
				System.out.println(q);
				_EncuentraConexionAPI2.persistir(q);
			
			cone = null;

		} catch (Exception e) {

			e.printStackTrace();
		}
	}


	public static EquiposPrintSpool darListaEquiposPrintSpool(Integer idEquipo, int idEmpresa) 
	{
		String qEquipo = "";
		if(idEquipo!=-1)
		{
			qEquipo = "AND idEquipo ="+idEquipo+" ";
		}
		
		String q = "SELECT idEquipo,ip_nombre,estado,fechaUpdate,Impresora1,Impresora2,Impresora3,Impresora4 FROM impresoras_estado WHERE idEmpresa = "+idEmpresa+" "+qEquipo;
		
		return _EncuentraConexionAPI2.darEquiposPrintSpool(q);
	}
	
	public List<DataIDDescripcion> pedidosCanceladosAPI(String pedidos, int idEmpresa){
		try {
			String query = "select 0,operationid,0,'' from producteca_ecom_pedidos where operationid in ("+pedidos+") and iscanceled=1";
			
			return _EncuentraConexionAPI2.darListaDataIdDescripcionConsulMYSQL(query);
			
		} catch (Exception e) {
			return new ArrayList<DataIDDescripcion>();
		}
	}
	
	public void saveImportCustomer(List<beans.encuentra.Cliente> clientes,int idEmpresa) 
	{
		try {
			StringBuilder sb = new StringBuilder();
			
			for (beans.encuentra.Cliente c: clientes) {
				String nroAP="";
				if(c.getNroApto()!=null)
				{
					nroAP = c.getNroApto();
				}
				sb.append("INSERT IGNORE INTO ecommerce_import_clientes (Nombre,Apellido,Direccion,Ciudad,Departamento,cpostal,telefono,mail,cedula,"
						+ "digito,idPedido,DireccionNota,IdEmpresa,nroPuerta,apto) " + 
						"VALUES ('"+c.getNombre()+"','"+c.getApellido()+"','"+c.getCalle()+"', "
								+ "'"+c.getCiudad()+"','"+c.getDepartamento()+"','"+c.getCp()+"','"+c.getTelefono()+"','"+c.getEmail()+"', "
										+ "'"+c.getDocumentoNro()+"',"
										+ "'',"+c.getIdPedido()+",'"+c.getObs()+"',"+idEmpresa+",'"+c.getNroPuerta()+"','"+nroAP+"'); ");
			}
			
			persistir(sb.toString());
		} catch (Exception e) {
			e.printStackTrace();
		}		
	}
	public void saveImport1Customer(beans.encuentra.Cliente c,int idEmpresa) 
	{
		try {
			StringBuilder sb = new StringBuilder();
			
			String nroAP="";
			if(c.getNroApto()!=null)
			{
				nroAP = c.getNroApto();
			}
			sb.append("INSERT INTO ecommerce_import_clientes (Nombre,Apellido,Direccion,Ciudad,Departamento,cpostal,telefono,mail,cedula,"
					+ "digito,idPedido,DireccionNota,IdEmpresa,nroPuerta,apto) " + 
					"VALUES ('"+c.getNombre()+"','"+c.getApellido()+"','"+c.getCalle()+"', "
							+ "'"+c.getCiudad()+"','"+c.getDepartamento()+"','"+c.getCp()+"','"+c.getTelefono()+"','"+c.getEmail()+"', "
									+ "'"+c.getDocumentoNro()+"',"
									+ "'',"+c.getIdPedido()+",'"+c.getObs()+"',"+idEmpresa+",'"+c.getNroPuerta()+"','"+nroAP+"'); ");
		
		
			persistir(sb.toString());
		} catch (Exception e) {
			e.printStackTrace();
		}		
	}
	
	//MOVIMIENTOS DE STOCK
	public int RegistrarMovimientoStock(int origen, int destino, int usu, List<DataIDDescripcion> arts, int idEmpresa,Long OrigenDoc, int docSolicitud, 
			int razon, boolean entrega) 
	{		
		int idRegistro = 0;
		int intEntrega = 0;
		if(entrega) {
			intEntrega = 1;
		}
		try {			
			String registro = "insert into movStock_cabezal(usuario,origen,destino,idEmpresa,origenDoc,docSolicitud,razon,entrega) "
					+ "values("+usu+","+origen+","+destino+","+idEmpresa+","+OrigenDoc+","+docSolicitud+","+razon+","+intEntrega+")";
			
			
			Connection cone;
			cone = _EncuentraConexionAPI2.getConnection();
			
			idRegistro = _EncuentraConexionAPI2.persistirDarUltimo(registro, "movStock_cabezal", "id",idEmpresa);
			cone =null;
			StringBuilder sb = new StringBuilder();
			for(DataIDDescripcion a:arts){
				sb.append("insert into movstock_detalle values ("+idRegistro+",'"+a.getDescripcion()+"',"+a.getId()+","+idEmpresa+");");
			}
			
			System.out.println(sb.toString());
			persistir(sb.toString());
			
		}catch (Exception e) 
		{
			e.printStackTrace();
		}
		return idRegistro;
	}
	
	public List<MovStock> queueMovsStock(int idEmpresa, int id){
		@SuppressWarnings("unused") Connection cone;
		
		List<MovStock> movs = null;
		try 
		{
			cone = _EncuentraConexionAPI2.getConnection();
			String idQuery = "";
			if(id!=0) {
				idQuery = " and c.id ="+id;
			}
			String query = "SELECT c.id,c.estado,c.destino,c.doc,sum(d.cantidad),c.fecha,c.observacion,'', "
					+"origen,c.origenDoc,c.intentos,DocSolicitud,razon,c.usuario,c.msjErp,c.entrega FROM movStock_cabezal c "
					+"INNER JOIN movstock_detalle d on c.id=d.id and d.idempresa=c.idempresa "
					+"WHERE c.idempresa="+idEmpresa+idQuery +" GROUP by c.id,c.estado,c.destino,c.doc,c.fecha,c.observacion,'', " + 
							"origen,c.origenDoc,c.intentos,DocSolicitud,razon order by c.fecha desc limit 500";
			
			movs = _EncuentraConexionAPI2.darQueueMovsStock(query,idEmpresa);		
			cone=null;
			return movs;
		}
		catch (Exception e)
		{
			return movs;
		}
	}
	
	public List<MovStock> queuePendingMovsStock(int idEmpresa, int id){
		@SuppressWarnings("unused") Connection cone;
		
		List<MovStock> movs = null;
		try 
		{
			cone = _EncuentraConexionAPI2.getConnection();
			String idQuery = "";
			if(id!=0) {
				idQuery = " and c.id ="+id;
			}
			String query = "SELECT c.id,c.estado,c.destino,c.doc,sum(d.cantidad),c.fecha,c.observacion,'', "
					+"origen,c.origenDoc,c.intentos,DocSolicitud,razon,c.usuario,c.msjErp,c.entrega FROM movStock_cabezal c "
					+"INNER JOIN movstock_detalle d on c.id=d.id and d.idempresa=c.idempresa "
					+"WHERE estado = 0 and c.idempresa="+idEmpresa+idQuery +" GROUP by c.id,c.estado,c.destino,c.doc,c.fecha,c.observacion,'', " + 
							"origen,c.origenDoc,c.intentos,DocSolicitud,razon";
			
			movs = _EncuentraConexionAPI2.darQueueMovsStock(query,idEmpresa);		
			cone=null;
			return movs;
		}
		catch (Exception e)
		{
			return movs;
		}
	}
	
	public List<MovStock> obtenerMovsStock(int idEmpresa, Long origeneDoc){
		@SuppressWarnings("unused") Connection cone;
		
		List<MovStock> movs = null;
		try 
		{
			cone = _EncuentraConexionAPI2.getConnection();
			String idQuery = "";
			String query = "SELECT c.id,c.estado,c.destino,c.doc,sum(d.cantidad),c.fecha,c.observacion,'', "
					+"origen,c.origenDoc,c.intentos,DocSolicitud,razon,c.usuario,c.msjErp,c.entrega FROM movStock_cabezal c "
					+"INNER JOIN movstock_detalle d on c.id=d.id and d.idempresa=c.idempresa "
					+"WHERE estado = 1 and c.idempresa="+idEmpresa+idQuery +" and c.origenDoc = "+origeneDoc+" " + 
							"GROUP by c.id,c.estado,c.destino,c.doc,c.fecha,c.observacion,'', " + 
							"origen,c.origenDoc,c.intentos,DocSolicitud,razon";
			
			movs = _EncuentraConexionAPI2.darQueueMovsStock(query,idEmpresa);		
			cone=null;
			return movs;
		}
		catch (Exception e)
		{
			return movs;
		}
	}
	
	public void RegistrarDocMovimientoStock(int ok, int idRegistro, int doc, String obs, int idEmpresa, int usu, int intentos) {
		Connection cone;
		try {
			String registro = "update movStock_cabezal set estado = "+ok+", doc = "+doc+", msjERP='"+obs+"',"
					+ " usuario = "+usu+", intentos = intentos+"+intentos
					+ " where id = "+idRegistro+" and idEmpresa="+idEmpresa;
			
			persistir(registro);
			
		}catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	//CONFIMRACION DE MOVIMIENTOS
	public int RegistrarConfirmacionTransferencia(int origen, int destino, int usu, List<DataIDDescripcion> arts, int idEmpresa,Long OrigenDoc, 
			int docSolicitud, int razon, int doc) 
	{
		Connection cone;
		int idRegistro = 0;
		try 
		{
			cone = _EncuentraConexionAPI2.getConnection();
			String registro = "insert into mov_confirm_trans"
					+ "f_cabezal(usuario,origen,destino,idEmpresa,origenDoc,docSolicitud,razon,doc) "
					+ "values("+usu+","+origen+","+destino+","+idEmpresa+","+OrigenDoc+","+docSolicitud+","+razon+","+doc+")";
			
			idRegistro = _EncuentraConexionAPI2.persistirDarUltimo(registro, "mov_confirm_transf_cabezal", "id",idEmpresa);
			cone = null;
			StringBuilder sb = new StringBuilder();
			for(DataIDDescripcion a:arts){
				sb.append("insert into mov_confirm_transf_detalle values ("+idRegistro+",'"+a.getDescripcion()+"',"+a.getId()+","+idEmpresa+");");
			}
			
			System.out.println(sb.toString());
			persistir(sb.toString());
			
		}catch (Exception e) {
			// TODO: handle exception
		}
		return idRegistro;
	}
	
	public List<MovStock> queueConfirmacionTransferencia(int idEmpresa){
		@SuppressWarnings("unused") Connection cone;
		List<MovStock> movs = null;
		try 
		{
			cone = _EncuentraConexionAPI2.getConnection();
			
			String query = "SELECT c.id,c.estado,c.destino,c.doc,sum(d.cantidad),c.fecha,c.observacion,'Encuentra', "
					+"c.origen,c.origenDoc,c.intentos,'Ecommerce',docSolicitud,razon,usuario,msjerp FROM mov_confirm_transf_cabezal c "
					+"INNER JOIN mov_confirm_transf_detalle d on c.id=d.id and d.idempresa=c.idempresa "
					+"WHERE c.idempresa="+idEmpresa+" and estado=0 GROUP BY c.id ORDER BY c.fecha desc";
			System.out.println(query);
			movs = _EncuentraConexionAPI2.darQueueConfirmacionTransferencia(query,idEmpresa);
			cone = null;
			return movs;
		}
		catch (Exception e)
		{
			return movs;
		}
	}
	
	public void RegistrarEstadoConfirmacionTransferencia(boolean grabo, int idRegistro, String obs, int idEmpresa, int usu, int intentos) {
		
		int ok = 0;
		try {
			
			if(grabo) {
				ok = 1;
			}
			String registro = "update mov_confirm_transf_cabezal set estado = "+ok+", msjERP='"+obs+"',"
					+ " usuario = "+usu+", intentos = intentos+"+intentos
					+ " where id = "+idRegistro+" and idEmpresa="+idEmpresa;
			
			persistir(registro);
			
		}catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	//RECEPCIONES
		public int RegistrarRecepcion(GrabarRecepcion r) 
		{		
			@SuppressWarnings("unused") Connection cone;
			int idRegistro = 0;
			try 
			{			
				cone = _EncuentraConexionAPI2.getConnection();
				String registro = "insert into mov_recepcion_cabezal(destino,usuario,observacion,numeroDoc,nroProveedor,"
						+ "serieRemito,nroRemito,idRecepcion,tipoAfecta,idEmpresa) "
						+ "values("+r.getDestino()+","+r.getIdUsuario()+",'"+r.getObservacion()+"',"+r.getNumeroDoc()+","+r.getNroProveedor()+",'"+
						r.getSerieRemito()+"',"+r.getNroRemito()+","+r.getIdRecepcion()+",'"+r.getTipoAfecta()+"',"+r.getIdEmpresa()+")";
				
				idRegistro = _EncuentraConexionAPI2.persistirDarUltimo(registro, "mov_recepcion_cabezal", "id",r.getIdEmpresa());
				cone = null;
				StringBuilder sb = new StringBuilder();
				for(DataIDDescripcion a: r.getDetalle()){
					sb.append("insert into mov_recepcion_detalle values ("+idRegistro+",'"+a.getDescripcion()+"',"+a.getId()+","+r.getIdEmpresa()+");");
				}
				
				System.out.println(sb.toString());
				persistir(sb.toString());
				
			}catch (Exception e) {
				// TODO: handle exception
			}
			return idRegistro;
		}
		
		public List<GrabarRecepcion> queueRecepciones(int idEmpresa){
			@SuppressWarnings("unused") Connection cone;
			List<GrabarRecepcion> recepciones = null;
			try 
			{
				cone = _EncuentraConexionAPI2.getConnection();
				String query = "SELECT c.id,c.fecha,c.estado,c.destino, usuario, observacion, numeroDoc,"
						+ "nroProveedor, serieRemito, nroRemito, idRecepcion, tipoAfecta, idEmpresa, intentos, ultimoUpdate, msjERP"
						+" FROM mov_confirm_transf_cabezal c "
						+"INNER JOIN mov_confirm_transf_detalle d on c.id=d.id and d.idempresa=c.idempresa "
						+"WHERE c.idempresa="+idEmpresa+" and estado=0 GROUP BY c.id ORDER BY c.fecha desc";
				
				recepciones = _EncuentraConexionAPI2.darQueueRecepciones(query,idEmpresa);
				cone = null;
				return recepciones;
			}
			catch (Exception e)
			{
				return recepciones;
			}
		}
		
		public void RegistrarEstadoRecepcion(boolean grabo, int idRegistro, String obs, int idEmpresa, int usu, int intentos) {
			Connection cone;
			int ok = 0;
			try {
				if(grabo) {
					ok = 1;
				}
				String registro = "update mov_recepcion_cabezal set estado = "+ok+", msjERP='"+obs+"',"
						+ " usuario = "+usu+", intentos = intentos+"+intentos
						+ " where id = "+idRegistro+" and idEmpresa="+idEmpresa;
				
				persistir(registro);
				
			}catch (Exception e) {
				// TODO: handle exception
			}
		}
	
	//ORDENES
	
	public OrdenVenta darOrdenVenta(Long idPedido) 
	{

		String consulta = "select 0, V.porcDescuento,'UYU' ,V.clicedula, V.clinombre, V.clidireccion, V.cliRuc, V.clitelefono, '', V.idVenta, V.uletiqueta, V.FP, V.ML, V.Comentario, "
				+ "importePago, p.idCanalML, p.stampTime, if(isnull(fp.idFormaVisual),'',fp.idFormaVisual)  from ecommerce_import_venta V "
				+ "where  idVenta = "+idPedido;
		OrdenVenta orden = null;
		try
		{		
			orden = _EncuentraConexionAPI2.encuentraPedidosOrdenVenta(consulta);			
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		
		return orden;
		
	}
	
	public List<OrdenVenta> darOrdensSinFacturar(int idEmpresa) 
	{

		String consulta = "select 0, V.porcDescuento,'UYU' ,V.clicedula, V.clinombre, V.clidireccion, V.cliRuc, V.clitelefono, '', V.idVenta, V.uletiqueta, V.FP, V.ML, V.Comentario, "
				+ "importePago, 0, CURRENT_TIMESTAMP(), '', V.cliRuc  from ecommerce_import_venta V "
				+ "where Sincronizada=0 and idEmpresa="+idEmpresa;
		List<OrdenVenta> ordenes = null;
		try
		{		
			ordenes = _EncuentraConexionAPI2.ListarOrdenesSF(consulta);			
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		
		return ordenes;
		
	}
	
	public void CheckInOrder(Long idOrden, int idEmpresa) {
		try {
			String checkIn = "update ecommerce_import_venta set sincronizada = 0"+
					" where sincronizada = -1 and idVenta = "+idOrden+" and idEmpresa="+idEmpresa;
			
			persistir(checkIn);
			
		}catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	public void RegistrarFactura(Long idOrden, int factura, int idEmpresa, String comentario) {
		try {
			int ok = 0;
			if(factura!=0) {
				ok = 1;
			}
			String registro = "update ecommerce_import_venta set sincronizada = "+ok+", nroFactura = "+factura+ ", msjERP='"+comentario+"'"+
					" where idVenta = "+idOrden+" and idEmpresa="+idEmpresa;
			
			persistir(registro);
			
		}catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	public List<beans.encuentra.Cliente> darClientesSinGrabar(int idEmpresa) 
	{
		String q = "SELECT Nombre,Apellido,Direccion,Ciudad,Departamento,cpostal,telefono,mail,cedula,digito,DireccionNota, nroPuerta, apto "
				+ "FROM ecommerce_import_clientes WHERE sincronizado=0 AND IdEmpresa="+idEmpresa+"";
				
		List<beans.encuentra.Cliente> clientes = null;
		try
		{			
			clientes =  _EncuentraConexionAPI2.darClientes(q);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		return clientes;
	}
	
	public beans.encuentra.Cliente darCliente(Long idpedido, int idEmpresa) 
	{
		String q = "SELECT Nombre,Apellido,Direccion,Ciudad,Departamento,cpostal,telefono,mail,cedula,digito,DireccionNota, nroPuerta, apto "
				+ "FROM ecommerce_import_clientes WHERE idpedido="+idpedido+" AND IdEmpresa="+idEmpresa+"";
				
		beans.encuentra.Cliente cliente = null;
		try
		{			
			cliente =  _EncuentraConexionAPI2.darCliente(q);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		return cliente;
	}
	
	public void SincronizarCliente(String documento,  int idEmpresa) {
		try {
			String registro = "update ecommerce_import_clientes set sincronizado = 1 "+
					" where cedula = '"+documento+"' and idEmpresa="+idEmpresa;
			
			persistir(registro);
			
		}catch (Exception e) {
			// TODO: handle exception
		}
	}
	
	public Hashtable<Integer,pedidoFactura> pedidosSinFactura(Hashtable<Integer,pedidoFactura> pedidos) 
	{
		String q = "SELECT idpedido,nroFactura FROM producteca_ecom_facturas WHERE pdf='' ";
				
		try
		{			
			pedidos =  _EncuentraConexionAPI2.darPedidosSinFactura(q, pedidos);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		return pedidos;
	}
	
	public Hashtable<Integer,pedidoFactura> facturasVisual(Hashtable<Integer,pedidoFactura> pedidos) 
	{
		Enumeration<Integer> elements = pedidos.keys(); 
		String docs = "";
		while (elements.hasMoreElements()) {
			docs += elements.nextElement()+",";			
		}
		
		docs = docs.substring(0,docs.length()-1);
		String q = "SELECT NumeroDoc,Archivo FROM DocArchivo WHERE iddeposito=1200 and idListaEmpresa=1 and idTipoDocumento='VCO' and NumeroDoc in ("+docs+")";
				
		try
		{			
			pedidos =  MSSQL_API.darFacturasVisual(q, pedidos);
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
		return pedidos;
	}
	
	
	
	public void guardarFacturas(List<pedidoFactura> pedidos) 
	{
		
		StringBuilder sb = new StringBuilder();
		for(pedidoFactura p : pedidos) {
			sb.append("insert into producteca_ecom_facturas (idPedido,nroFactura,pdf) values "
					+ "("+p.getIdPedido()+","+p.getNroFactura()+",'"+p.getPdf()+"') on duplicate key update nroFactura = "+p.getNroFactura()+", pdf = '"+p.getPdf()+"';");
		}
				
		try
		{			
			persistir(sb.toString());
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}
	}
	
	public static boolean putColaEstadoMarketPlace (List<jsonEstadoMP> lista) {
		String insert = "";
		try {
			for(jsonEstadoMP e:lista) {
				insert += "insert ignore into ecommerce_cola_estados (idPedido, idMarketPlace, json, canal, idEmpresa) values "
						+ "("+e.getIdPedido()+", '"+e.getIdMarketPlace()+"', '"+e.getJson()+"',"+e.getCanal()+","+e.getIdEmpresa()+");";
			}
			persistir(insert);
			return true;
		} catch (Exception e) {
			e.printStackTrace();
			return false;
		}
		
	}
	
	public static List<jsonEstadoMP> PendienteColaEstadoMarketPlace(int canal, int idEmpresa) {
		@SuppressWarnings("unused") Connection cone;
		try {
			String query = "select id, idPedido, json, canal, idEmpresa, idMarketPlace from ecommerce_cola_estados where ok = 0 AND canal="+canal+" and idEmpresa="+idEmpresa;
			return _EncuentraConexionAPI2.DarPendienteColaEstadoMarketPlace(query);
		} catch (Exception e) {
			e.printStackTrace();
			return new ArrayList<jsonEstadoMP>();
		}
	}
	
	public static List<jsonEstadoMP> PendienteColaEstadoMarketPlace(int idEmpresa) {
		@SuppressWarnings("unused") Connection cone;
		try {
			String query = "select id, idPedido, json, canal, idEmpresa, idMarketPlace from ecommerce_cola_estados where ok = 0 and idEmpresa="+idEmpresa;
			return _EncuentraConexionAPI2.DarPendienteColaEstadoMarketPlace(query);
		} catch (Exception e) {
			e.printStackTrace();
			return new ArrayList<jsonEstadoMP>();
		}
	}
	
	public static void updateColaEstadoMarketPlace(String id) {
		try {
			String update = "update ecommerce_cola_estados set ok=1 where idMarketPlace = '"+id+"' and ok=0";			
			persistir(update);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	public static Hashtable<Integer, CanalMarketPlace> canalesMarketPlace(int idEmpresa, int idMarketPlace){
		
		Hashtable<Integer, CanalMarketPlace> canales = null;
		try {
			canales =  _EncuentraConexionAPI2.DarCanalesMarketPlace(idEmpresa, idMarketPlace);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return canales;
	}
	
public static List<DataIDDescripcion> Empresas(){
		
		List<DataIDDescripcion> empresas = null;
		String query = "select idempresa, descripcion from empresa";
		try {
			empresas =  _EncuentraConexionAPI2.darlistaDataIdDesc(query);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return empresas;
	}

public List<DataIDDescripcion> darEtiquetasZPL(String fechaDesde){
	
	List<DataIDDescripcion> etiquetas = null;
	String query = 	"SELECT operationid, pdf " +
				"FROM producteca_ecom_pedidos " +
				"WHERE fec_ult_act > '"+fechaDesde+"' AND pdf != '' ";
	try {
		etiquetas =  _EncuentraConexionAPI2.darlistaLongDesc(query);
	} catch (Exception e) {
		e.printStackTrace();
	}
	return etiquetas;
}


public void actualizarokenVivoCliente(int idEmpresa, String uso, String access_token) 
{
	persistir("INSERT INTO temp_tokens (idEmpresa,Uso,token) VALUES ("+idEmpresa+",'"+uso+"','"+access_token+"') ON DUPLICATE KEY UPDATE token = VALUES (token)");
	
}


public static List<DataIDDescripcion> darEtiquetasClientesShopify(){
	List<DataIDDescripcion> etiquetas = null;
	String query = "SELECT pep.OPERATIONID, pep.MAIL, pef.pdf \r\n" + 
			"FROM producteca_ecom_pedidos pep \r\n" + 
			"JOIN producteca_ecom_facturas pef ON pef.idPedido = pep.OPERATIONID\r\n" + 
			"WHERE pep.MARKETPLACE = 60 \r\n" + 
			"AND pef.comunicada = 0;";
	try {
		etiquetas =  _EncuentraConexionAPI2.darlistaEtiquetasShopifyMail(query);
	} catch (Exception e) {
		e.printStackTrace();
	}
	return etiquetas;
}

public void mapeoArticulosfenicio(List<EncuentraPedidoArticulo> articulos, int idEmpresa) 
{
	String query = "";
	for(EncuentraPedidoArticulo a: articulos)
	{
		query += "insert into mapeo_articulos_fenicio (skuFenicio,idArticulo,idEmpresa) "
				+ "values ('"+a.getSKUFenicio()+"','"+a.getArticulo()+"',"+idEmpresa+") on duplicate key update idArticulo = idArticulo;";
	}
	persistir(query);
}

public static int RegistrarEnvioMailShopify(int idPedido) {
	String query = "UPDATE producteca_ecom_facturas \r\n" + 
			"SET comunicada=1 \r\n" + 
			"WHERE idPedido="+idPedido+";";
	int persistir = 0;
	try {
		persistir = _EncuentraConexionAPI2.persistir(query);
	} catch (Exception e) {
		// TODO Auto-generated catch block
		e.printStackTrace();
	}
	return persistir;
}


public void getMapeoArticulosfenicio(Lineas[] lineas, int idEmpresa){
	
	try {
		_EncuentraConexionAPI2.getMapeoArticulosfenicio(lineas, idEmpresa);
	} catch (Exception e) {
		e.printStackTrace();
	}
	
}

public static List<CallBackPedido> getCallBackPedidoEncuentra(){
	List<CallBackPedido> callBacks = null;
	String query = "SELECT idLLamada, idPedido, idEstado, estampa, procesado, fechaProcesado, mensaje, idEmpresa FROM callbackpedidoencuentra WHERE procesado = 0;";
	try {
		callBacks = _EncuentraConexionAPI2.darCallBackPedidoEncuentra(query);
	} catch(Exception e){
		e.printStackTrace();
	}
	return callBacks;
	
}

public static Hashtable<String, Double> darArtPrecio(String inns, int idEmpresa) 
{
	Hashtable<String, Double> retorno = null;
	String query = "SELECT idArticulo,Precio FROM art_precio WHERE idArticulo IN ("+inns+") AND idEmpresa="+idEmpresa+";";
	try 
	{
		retorno = _EncuentraConexionAPI2.darArtPrecio(query);
	} 
	catch(Exception e)
	{
		e.printStackTrace();
	}
	return retorno;
}




}